#!/usr/bin/env groovy

node {
    
    // Cleanup workspace
    deleteDir()
    
    //Clone example project from GitHub repository
    //git url: 'https://github.com/jfrogtraining/kubernetes_example.git', branch: 'master'
    def rtServer = Artifactory.server art-1
    def rtDocker = Artifactory.docker server: rtServer
    def buildInfo = Artifactory.newBuildInfo()
    def tagDockerApp

    buildInfo.env.capture = true

    //Build docker image named docker-app
    stage ('Build & Deploy') {
        dir ('docker-app') {
            sh "sed -i 's/docker.artifactory/${ARTDOCKER_REGISTRY}/' Dockerfile"
            tagDockerApp = "${ARTDOCKER_REGISTRY}/docker-app:${env.BUILD_NUMBER}"
            println "Docker App Build"
            docker.build(tagDockerApp)
            println "Docker push" + tagDockerApp + " : " + REPO
            buildInfo = rtDocker.push(tagDockerApp, REPO, buildInfo)
            println "Docker Buildinfo"
            rtServer.publishBuildInfo buildInfo
        }
     }
